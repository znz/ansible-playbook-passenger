---
- name: passenger installed version
  ignore_errors: yes
  register: passenger_installed_version
  shell: |
   set -e
   . /etc/profile.d/rbenv.sh
   gem list passenger | awk '$1=="passenger"{gsub("[(,)]","");print $2}'

- name: passenger outdated
  ignore_errors: yes
  register: passenger_outdated
  when: passenger_installed_version.stdout != ""
  shell: |
   set -e
   . /etc/profile.d/rbenv.sh
   gem outdated | egrep '^passenger ' || :

- name: install passenger
  when: passenger_installed_version.stdout == "" or passenger_outdated != ""
  shell: |
   set -e
   . /etc/profile.d/rbenv.sh
   if test -z "{{ passenger_installed_version.stdout }}"; then
     gem install passenger
   else
     gem update passenger
   fi
   rbenv rehash

- name: passenger apache2 module path
  ignore_errors: yes
  register: passenger_apache2_module_path
  shell: |
   set -e
   . /etc/profile.d/rbenv.sh
   passenger-install-apache2-module --snippet | awk '/LoadModule/{print $NF}'

- name: install passenger install apache2 module
  shell: |
   create={{ passenger_apache2_module_path }}
   set -e
   . /etc/profile.d/rbenv.sh
   passenger-install-apache2-module --auto

- name: create apache2 passenger.conf
  shell: |
   create=/etc/apache2/conf.d/passenger.conf
   {
     echo PassengerMaxPoolSize 3
     echo PassengerPoolIdleTime 300
     echo PassengerMaxRequests 1000
     echo PassengerStatThrottleRate 10
     echo '#PassengerHighPerformance on'
     echo
     passenger-install-apache2-module --snippet
     echo
     echo '# vim:set ft=apache:'
   } > /etc/apache2/conf.d/passenger.conf
  notify:
  - restart apache2
